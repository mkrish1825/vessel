name: Restrict Non-Release Branch Merges to Master

on:
  pull_request_target:
    branches:
      - master
    types: [opened, reopened, synchronize, ready_for_review]

permissions:
  pull-requests: write
  contents: read

jobs:
  restrict-merge:
    runs-on: ubuntu-latest
    steps:
      - name: Validate Source Branch
        id: check_branch
        run: |
          echo "Source branch: ${{ github.event.pull_request.head.ref }}"
          if [[ ! "${{ github.event.pull_request.head.ref }}" =~ ^release/ ]]; then
            echo "not_allowed=true" >> $GITHUB_OUTPUT
          else
            echo "not_allowed=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR if restricted
        if: steps.check_branch.outputs.not_allowed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const branch = context.payload.pull_request.head.ref;
            const message = `ðŸš« **Merge Blocked!**
Merging from branch **${branch}** to **master** is not allowed.
Only branches following the pattern **release/** can be merged into master.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });

            core.setFailed("Merges from non-release branches are not allowed.");

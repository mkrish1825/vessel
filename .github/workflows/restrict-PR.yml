name: Restrict Merge to Master

on:
  pull_request:
    branches:
      - master
    types: [opened, reopened, synchronize, ready_for_review]

permissions:
  pull-requests: write
  contents: read

jobs:
  check-source-branch:
    runs-on: ubuntu-latest
    steps:
      - name: Check source branch
        id: check
        run: |
          echo "Checking if source branch is from release/*..."
          SOURCE_BRANCH="${{ github.head_ref }}"
          echo "Source branch: $SOURCE_BRANCH"
          if [[ ! "$SOURCE_BRANCH" =~ ^release/ ]]; then
            echo "not_allowed=true" >> $GITHUB_OUTPUT
            echo "‚ùå Merging from '$SOURCE_BRANCH' to 'master' is not allowed!"
            exit 0
          else
            echo "not_allowed=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Source branch allowed: $SOURCE_BRANCH"
          fi

      - name: Comment and Fail if Restricted
        if: steps.check.outputs.not_allowed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const branch = context.payload.pull_request.head.ref;
            const message = `üö´ **Merge Blocked!**
Merging from branch **${branch}** to **master** is not allowed.
Only branches following the pattern **release/** are permitted to merge into master.`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });
            core.setFailed("‚ùå Merge blocked: Only release/* branches can be merged to master.");

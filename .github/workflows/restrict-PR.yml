name: Restrict Merge to Master

on:
  pull_request:
    branches:
      - master
    types: [opened, reopened, synchronize, ready_for_review]

jobs:
  check-source-branch:
    runs-on: ubuntu-latest
    steps:
      - name: Check source branch and comment if invalid
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîç Validating source branch..."
          SOURCE_BRANCH="${{ github.head_ref }}"
          echo "‚û°Ô∏è Source branch detected: $SOURCE_BRANCH"

          if [[ ! "$SOURCE_BRANCH" =~ ^release/ ]]; then
            echo "‚ùå Merge blocked: $SOURCE_BRANCH ‚Üí master"
            
            COMMENT="‚ùå **Merge Blocked!**
üö´ Merging from branch \`$SOURCE_BRANCH\` to \`master\` is **not allowed**.
‚úÖ Only branches matching the pattern \`release/*\` are permitted to merge into master.

Please create a release branch (e.g. \`release/v1.2.0\`) and open the PR from that branch."

            # Post comment on PR
            gh api repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments \
              -f body="$COMMENT"

            exit 1
          fi

          echo "‚úÖ Merge allowed: $SOURCE_BRANCH ‚Üí master"

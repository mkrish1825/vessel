name: Restrict Merge to Master

on:
  pull_request:
    branches:
      - master
    types: [opened, reopened, synchronize, ready_for_review]

permissions:
  pull-requests: write   # needed to post a comment

jobs:
  restrict-merge:
    runs-on: ubuntu-latest
    steps:
      - name: Check if source branch is allowed
        id: branch_check
        run: |
          echo "Source branch: ${{ github.head_ref }}"
          if [[ ! "${{ github.head_ref }}" =~ ^release/ ]]; then
            echo "not_allowed=true" >> $GITHUB_OUTPUT
          else
            echo "not_allowed=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR if restricted
        if: steps.branch_check.outputs.not_allowed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸš« Merge Blocked!

Merging from branch **${context.payload.pull_request.head.ref}** to **master** is **not allowed**.

Only branches following the pattern **release/** are permitted to merge into master.`
            })
            core.setFailed("Merges from non-release branches are not allowed.")
